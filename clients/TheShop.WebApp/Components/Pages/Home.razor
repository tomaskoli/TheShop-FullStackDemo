@page "/"
@inject TheShopApiClient Api
@inject CustomAuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ILogger<Home> Logger
@implements IAsyncDisposable
@rendermode InteractiveServer

<PageTitle>Products - TheShop</PageTitle>

<div class="page-header">
    <h1>Products</h1>
    <p>Discover our collection of quality products</p>
</div>

@if (!string.IsNullOrEmpty(_error))
{
    <div class="alert alert-danger" style="margin-bottom:1rem;">
        <i class="bi bi-exclamation-triangle"></i> @_error
        <button type="button" class="btn-close" style="float:right;" @onclick="() => _error = null"></button>
    </div>
}

<div class="filters">
    <input type="text" 
           class="form-control search-input" 
           placeholder="Search products..." 
           @bind="_search" 
           @bind:after="ResetAndLoad" />

    <select class="filter-select" @bind="_selectedBrand" @bind:after="ResetAndLoad">
        <option value="">All Brands</option>
        @foreach (var brand in _brands)
        {
            <option value="@brand.Id">@brand.Name</option>
        }
    </select>

    <select class="filter-select" @bind="_selectedCategory" @bind:after="ResetAndLoad">
        <option value="">All Categories</option>
        @foreach (var category in _categories)
        {
            <option value="@category.Id">@category.Name</option>
        }
    </select>
</div>

@if (_initialLoading)
{
    <div class="loading">
        <div class="spinner"></div>
        <span>Loading products...</span>
    </div>
}
else if (!_displayedProducts.Any() && !_loadingMore)
{
    <div class="empty-state">
        <i class="bi bi-box-seam"></i>
        <h3>No products found</h3>
        <p>Try adjusting your filters or search terms.</p>
    </div>
}
else
{
    <div class="results-info">
        <span>Showing <strong>@_displayedProducts.Count</strong> of <strong>@_totalCount</strong> products</span>
    </div>

    <div class="product-grid">
        @foreach (var product in _displayedProducts)
        {
            var isAdding = _addingProductId == product.Id;
            <div class="card product-card">
                <a href="/product/@product.Id" class="product-link">
                    <div class="product-image">
                        @if (!string.IsNullOrEmpty(product.ImageUrl))
                        {
                            <img src="@product.ImageUrl" alt="@product.Name" />
                        }
                        else
                        {
                            <i class="bi bi-image"></i>
                        }
                    </div>
                    <div class="product-info-preview">
                        <span class="product-brand">@product.BrandName</span>
                        <h3 class="product-name">@product.Name</h3>
                        <span class="product-category">@product.CategoryName</span>
                    </div>
                </a>
                <div class="product-footer">
                    <span class="product-price">$@product.Price.ToString("N2")</span>
                    <AuthorizeView>
                        <Authorized>
                            <button class="btn btn-primary btn-sm" @onclick="() => AddToBasket(product)" disabled="@isAdding">
                                @if (isAdding)
                                {
                                    <span>Adding...</span>
                                }
                                else
                                {
                                    <i class="bi bi-bag-plus"></i>
                                    <span> Add</span>
                                }
                            </button>
                        </Authorized>
                        <NotAuthorized>
                            <a href="/login" class="btn btn-primary btn-sm">
                                <i class="bi bi-box-arrow-in-right"></i>
                                <span> Login to Buy</span>
                            </a>
                        </NotAuthorized>
                    </AuthorizeView>
                </div>
            </div>
        }
    </div>

    @if (_hasMoreItems)
    {
        <div class="lazy-load-trigger" @ref="_loadMoreTrigger">
            @if (_loadingMore)
            {
                <div class="loading-more">
                    <div class="spinner-sm"></div>
                    <span>Loading more products...</span>
                </div>
            }
            else
            {
                <button class="btn btn-outline load-more-btn" @onclick="LoadMore">
                    <i class="bi bi-arrow-down-circle"></i> Load More Products
                </button>
            }
        </div>
    }
    else if (_displayedProducts.Any())
    {
        <div class="end-of-list">
            <i class="bi bi-check-circle"></i>
            <span>All @_totalCount products loaded</span>
        </div>
    }
}

@code {
    private List<ProductDto> _displayedProducts = [];
    private ICollection<BrandDto> _brands = [];
    private ICollection<CategoryDto> _categories = [];
    private string _search = "";
    private string _selectedBrand = "";
    private string _selectedCategory = "";
    private int _page = 1;
    private int _totalCount;
    private int _totalPages;
    private const int PageSize = 12;
    private bool _initialLoading = true;
    private bool _loadingMore;
    private Guid? _addingProductId;
    private ElementReference _loadMoreTrigger;
    private DotNetObjectReference<Home>? _dotNetRef;
    private IJSObjectReference? _jsModule;
    private string? _error;

    private bool _hasMoreItems => _page < _totalPages;

    protected override async Task OnInitializedAsync()
    {
        await LoadFilters();
        await LoadInitialProducts();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _dotNetRef = DotNetObjectReference.Create(this);
            _jsModule = await JS.InvokeAsync<IJSObjectReference>("import", "./js/lazy-load.js");
            await SetupIntersectionObserver();
        }
    }

    private async Task SetupIntersectionObserver()
    {
        if (_jsModule != null && _hasMoreItems)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("observeElement", _loadMoreTrigger, _dotNetRef);
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, safe to ignore
            }
        }
    }

    [JSInvokable]
    public async Task OnIntersecting()
    {
        if (!_loadingMore && _hasMoreItems)
        {
            await LoadMore();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadFilters()
    {
        try
        {
            _brands = await Api.BrandsAsync();
            _categories = await Api.CategoriesAsync();
        }
        catch (ApiException ex)
        {
            Logger.LogWarning(ex, "Failed to load filters: {StatusCode}", ex.StatusCode);
        }
    }

    private async Task LoadInitialProducts()
    {
        _initialLoading = true;
        _error = null;
        StateHasChanged();

        try
        {
            Guid? brandId = Guid.TryParse(_selectedBrand, out var bid) ? bid : null;
            Guid? categoryId = Guid.TryParse(_selectedCategory, out var cid) ? cid : null;

            var result = await Api.ProductsGETAsync(1, PageSize, _search, brandId, categoryId);
            _displayedProducts = result.Items.ToList();
            _totalCount = result.TotalCount;
            _totalPages = result.TotalPages;
            _page = 1;
        }
        catch (ApiException ex)
        {
            Logger.LogError(ex, "Failed to load products: {StatusCode}", ex.StatusCode);
            _error = ApiErrorHandler.GetUserFriendlyMessage(ex, "Failed to load products. Please try again.");
            _displayedProducts = [];
            _totalCount = 0;
            _totalPages = 0;
        }
        finally
        {
            _initialLoading = false;
        }
    }

    private async Task ResetAndLoad()
    {
        _page = 1;
        _displayedProducts.Clear();
        await LoadInitialProducts();
        await SetupIntersectionObserver();
    }

    private async Task LoadMore()
    {
        if (_loadingMore || !_hasMoreItems)
        {
            return;
        }

        _loadingMore = true;
        StateHasChanged();

        try
        {
            _page++;
            Guid? brandId = Guid.TryParse(_selectedBrand, out var bid) ? bid : null;
            Guid? categoryId = Guid.TryParse(_selectedCategory, out var cid) ? cid : null;

            var result = await Api.ProductsGETAsync(_page, PageSize, _search, brandId, categoryId);
            _displayedProducts.AddRange(result.Items);
        }
        catch (ApiException ex)
        {
            Logger.LogWarning(ex, "Failed to load more products: {StatusCode}", ex.StatusCode);
            _error = ApiErrorHandler.GetUserFriendlyMessage(ex, "Failed to load more products.");
            _page--;
        }
        finally
        {
            _loadingMore = false;
        }

        if (_hasMoreItems)
        {
            await SetupIntersectionObserver();
        }
    }

    private async Task AddToBasket(ProductDto product)
    {
        if (_addingProductId.HasValue)
        {
            return;
        }

        _addingProductId = product.Id;
        _error = null;

        try
        {
            var basket = await Api.ItemsPOSTAsync(new AddToBasketRequest
            {
                ProductId = product.Id,
                Quantity = 1
            });
            AuthProvider.SetBasketCount(basket.Items.Count);
        }
        catch (ApiException ex)
        {
            Logger.LogWarning(ex, "Failed to add product to basket: {StatusCode}", ex.StatusCode);
            _error = ApiErrorHandler.GetUserFriendlyMessage(ex, "Failed to add item to basket.");
        }
        finally
        {
            _addingProductId = null;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_jsModule != null)
        {
            try
            {
                await _jsModule.InvokeVoidAsync("disconnect");
                await _jsModule.DisposeAsync();
            }
            catch (JSDisconnectedException)
            {
                // Circuit disconnected, safe to ignore
            }
        }
        _dotNetRef?.Dispose();
    }
}
