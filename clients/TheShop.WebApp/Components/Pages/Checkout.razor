@page "/checkout"
@attribute [Authorize]
@inject TheShopApiClient Api
@inject CustomAuthenticationStateProvider AuthProvider
@inject NavigationManager Navigation
@inject ILogger<Checkout> Logger
@rendermode InteractiveServer

<PageTitle>Checkout - TheShop</PageTitle>

<div class="page-header">
    <h1>Checkout</h1>
</div>

@if (_loading)
{
    <div class="loading">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>
}
else if (_basket == null || !_basket.Items.Any())
{
    <div class="empty-state">
        <i class="bi bi-bag"></i>
        <h3>Your basket is empty</h3>
        <a href="/" class="btn btn-primary">Browse Products</a>
    </div>
}
else
{
    <div class="checkout-grid">
        <div>
            <div class="auth-card">
                <h3 style="margin:0 0 1.5rem 0;">Shipping Address</h3>

                @if (!string.IsNullOrEmpty(_error))
                {
                    <div class="alert alert-danger">@_error</div>
                }

                <EditForm Model="_address" OnValidSubmit="PlaceOrder" FormName="checkout">
                    <div class="form-group">
                        <label class="form-label">Street Address</label>
                        <InputText @bind-Value="_address.Street" class="form-control" placeholder="123 Main Street" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">City</label>
                        <InputText @bind-Value="_address.City" class="form-control" placeholder="New York" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Postal Code</label>
                        <InputText @bind-Value="_address.PostalCode" class="form-control" placeholder="10001" />
                    </div>

                    <div class="form-group">
                        <label class="form-label">Country</label>
                        <InputText @bind-Value="_address.Country" class="form-control" placeholder="USA" />
                    </div>

                    <button type="submit" class="btn btn-primary w-100 btn-lg" disabled="@_submitting">
                        @if (_submitting)
                        {
                            <span>Processing...</span>
                        }
                        else
                        {
                            <i class="bi bi-check-lg"></i>
                            <span> Place Order</span>
                        }
                    </button>
                </EditForm>
            </div>
        </div>

        <div>
            <div class="basket-summary">
                <h3 style="margin:0 0 1rem 0;">Order Summary</h3>
                
                @foreach (var item in _basket.Items)
                {
                    <div style="display:flex;justify-content:space-between;padding:0.5rem 0;font-size:0.9rem;color:var(--text-secondary);">
                        <span>@item.ProductName Ã— @item.Quantity</span>
                        <span>$@item.TotalPrice.ToString("N2")</span>
                    </div>
                }
                
                <div class="summary-row" style="margin-top:1rem;">
                    <span>Subtotal</span>
                    <span>$@_basket.TotalPrice.ToString("N2")</span>
                </div>
                <div class="summary-row">
                    <span>Shipping</span>
                    <span>Free</span>
                </div>
                <div class="summary-row">
                    <span>Total</span>
                    <span class="total-price">$@_basket.TotalPrice.ToString("N2")</span>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private BasketDto? _basket;
    private AddressModel _address = new();
    private bool _loading = true;
    private bool _submitting;
    private string? _error;
    private string _idempotencyKey = Guid.NewGuid().ToString();

    protected override async Task OnInitializedAsync()
    {
        await LoadBasket();
    }

    private async Task LoadBasket()
    {
        _loading = true;
        _error = null;

        try
        {
            _basket = await Api.BasketGETAsync();
        }
        catch (ApiException ex)
        {
            Logger.LogError(ex, "Failed to load basket: {StatusCode}", ex.StatusCode);
            _error = ApiErrorHandler.GetUserFriendlyMessage(ex, "Failed to load basket.");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task PlaceOrder()
    {
        _error = null;
        _submitting = true;

        Api.SetIdempotencyKey(_idempotencyKey);

        try
        {
            var order = await Api.OrdersPOSTAsync(_idempotencyKey, new CreateOrderRequest
            {
                ShippingStreet = _address.Street,
                ShippingCity = _address.City,
                ShippingPostalCode = _address.PostalCode,
                ShippingCountry = _address.Country
            });

            AuthProvider.SetBasketCount(0);
            Navigation.NavigateTo($"/orders/{order.Id}");
        }
        catch (ApiException ex)
        {
            Logger.LogError(ex, "Failed to place order: {StatusCode}", ex.StatusCode);
            _error = ApiErrorHandler.GetUserFriendlyMessage(ex, "Failed to place order. Please try again.");
            _idempotencyKey = Guid.NewGuid().ToString();
        }
        finally
        {
            _submitting = false;
        }
    }

    private class AddressModel
    {
        public string Street { get; set; } = "";
        public string City { get; set; } = "";
        public string PostalCode { get; set; } = "";
        public string Country { get; set; } = "";
    }
}
